FROM registry.access.redhat.com/ubi8/ubi:latest

ENV PYTHON_VERSION=3.11

RUN yum -y update && \
    yum -y install gcc openssl-devel bzip2-devel libffi-devel zlib-devel make wget && \
    yum -y install gnupg2 pigz tar && \  # Install gpg, pigz, and tar
    yum clean all


RUN mkdir -p /home/bin

# CG expects these binaries to be availbable in /home/bin
RUN ln -s /usr/bin/gpg /home/bin/gpg && \
    ln -s /usr/bin/pigz /home/bin/pigz && \
    ln -s /usr/bin/tar /home/bin/tar

RUN cd /usr/src && \
    wget https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tgz && \
    tar xzf Python-${PYTHON_VERSION}.tgz && \
    cd Python-${PYTHON_VERSION} && \
    ./configure --enable-optimizations && \
    make altinstall

ENV PATH="/usr/local/bin:${PATH}"

RUN groupadd --system nonroot && \
    useradd --system --gid nonroot --create-home --no-log-init nonroot

WORKDIR /app

RUN python3.11 -m pip install --no-cache-dir poetry

COPY pyproject.toml poetry.lock /app/

RUN poetry config virtualenvs.create false && \
    poetry install --no-dev --no-interaction --no-ansi

COPY . /app/

USER nonroot
