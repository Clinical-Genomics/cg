{% from "bootstrap.html" import css, custom_css %}

<!DOCTYPE html>
<html lang="en">
  <body>
    <div class="container">

        <div class="card-block">
          <table class="table table-bordered" aria-describedby="Sample table">
            <thead>
              <tr>
                <th>Prov</th>
                <th>Beställt</th>
                <th>Fall</th>
                <th>Kön</th>
                <th>Provtyp</th>
                <th>Ticket</th>
                <th>Applikation</th>
                <th>Bioinformatisk analys</th>
                <th>Tumör</th>
              </tr>
            </thead>
            <tbody>
              {% for sample in case.samples %}
              <tr>
                <td>{{ sample.name }}* ({{ sample.id }})</td>
                <td>{{ sample.timestamps.ordered_at }}</td>
                <td>{{ case.name }}*</td>
                <td>{{ sample.gender }}*</td>
                <td>{{ sample.source }}*</td>
                <td>{{ sample.ticket }}</td>
                <td>{{ sample.application.tag }}*</td>
                <td>{{ case.data_analysis.customer_workflow }}*</td>
                <td>{{ sample.tumour }}*</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card-block">
          <table class="table table-bordered" aria-describedby="Sample table">
            <thead>
              <tr>
                <th>Prov</th>
                <th>Ankom</th>
                <th>Biblioteksberedning</th>
                <th>Beredd</th>
                {% if "panelsekvensering" in case.data_analysis.type %}
                <th>Bait Set</th>
                {% endif %}
                <th>Sekvensering</th>
                <th>Sekvenserad</th>
                <th>Bioinformatisk analys</th>
              </tr>
            </thead>
            <tbody>
              {% for sample in case.samples %}
              <tr>
                <td>{{ sample.name }}*</td>
                <td>{{ sample.timestamps.received_at }}</td>
                <td>{{ sample.methods.library_prep }}</td>
                <td>{{ sample.timestamps.prepared_at }}</td>
                {% if "panelsekvensering" in case.data_analysis.type %}
                <td>
                  {{ sample.metadata.bait_set }} {% if sample.metadata.bait_set != 'N/A' and
                  sample.metadata.bait_set_version != 'N/A' %} (version: {{
                  sample.metadata.bait_set_version }}) {% endif %}
                </td>
                {% endif %}
                <td>{{ sample.methods.sequencing }}</td>
                <td>{{ sample.timestamps.reads_updated_at }}</td>
                <td>{{ case.data_analysis.workflow }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="card-block">
          <table class="table table-bordered" aria-describedby="Case table">
            <thead>
              <tr>
                <th>Fall</th>
                <th>Balsamic-version</th>
                <th>Genomversion</th>
                <th>Analystyp</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>{{ case.name }}*</td>
                <td>{{ case.data_analysis.workflow_version }}</td>
                <td>{{ case.data_analysis.genome_build }}</td>
                <td>{{ case.data_analysis.type }}</td>
              </tr>
            </tbody>
            {% if case.data_analysis.workflow != 'balsamic-qc' %}
            <caption>
              <strong>Tillämpade filter för variantanrop</strong
              >: {{ case.data_analysis.variant_callers }}<br />
              <a href="https://balsamic.readthedocs.io/en/latest/balsamic_filters.html">
                https://balsamic.readthedocs.io/en/latest/balsamic_filters.html
              </a>
            </caption>
            {% endif %}
          </table>
        </div>

        <div class="card-block">
          <table class="table table-bordered" aria-describedby="Sample table">
            <thead>
              <tr>
                <th>Prov</th>
                <th>Läspar [M]</th>
                <th>Mediantäckning [baser]</th>
                {% if "helgenomsekvensering" in case.data_analysis.type %} {% if "normal" in
                case.data_analysis.type %}
                <th>Täckningsgrad 15x [%]</th>
                <th>Täckningsgrad 60x [%]</th>
                {% else %}
                <th>Täckningsgrad 60x [%]</th>
                {% endif %}
                <th>Läsningar med felaktiga par [%]</th>
                {% else %}
                <th>Täckningsgrad 250x [%]</th>
                <th>Täckningsgrad 500x [%]</th>
                <th>GC Dropout [%]</th>
                {% endif %}
                <th>Duplikat [%]</th>
                <th>Medelfragmentlängd [baspar]</th>
                <th>Fold 80 base penalty</th>
              </tr>
            </thead>
            <tbody>
              {% for sample in case.samples %}
              <tr>
                <td>{{ sample.name }}*</td>
                <td>{{ sample.metadata.million_read_pairs }}</td>
                {% if "helgenomsekvensering" in case.data_analysis.type %}
                <td>{{ sample.metadata.median_coverage }}</td>
                {% if "normal" in case.data_analysis.type %}
                <td>{{ sample.metadata.pct_15x }}</td>
                <td>{{ sample.metadata.pct_60x }}</td>
                {% else %}
                <td>{{ sample.metadata.pct_60x }}</td>
                {% endif %}
                <td>{{ sample.metadata.pct_reads_improper_pairs }}</td>
                {% else %}
                <td>{{ sample.metadata.median_target_coverage }}</td>
                <td>{{ sample.metadata.pct_250x }}</td>
                <td>{{ sample.metadata.pct_500x }}</td>
                <td>{{ sample.metadata.gc_dropout }}</td>
                {% endif %}
                <td>{{ sample.metadata.duplicates }}</td>
                <td>{{ sample.metadata.mean_insert_size }}</td>
                <td>{{ sample.metadata.fold_80 }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <caption>
              <strong>Förklaringar</strong
              ><br />
              <ins>Läspar</ins
              >: Antal sekvenseringsläsningar i miljoner läspar.<br />
              <ins>Mediantäckning</ins
              >: Median av täckningen över alla baser inkluderade i analysen.<br />
              <ins>Täckningsgrad</ins
              >: Andel baser som är sekvenserade med ett djup över en specificerad gräns, t.ex.
              100X.<br />
              <ins>Duplikat</ins
              >: Sekvenseringsläsningar som är i duplikat och därmed ej unika sekvenser. Hög mängd
              duplikat kan tyda på dålig komplexitet av sekvenserad bibliotek eller djup
              sekvensering.<br />
              <ins>Medelfragmentlängd</ins
              >: Medelstorlek av provbiblioteken som laddats på sekvenseringsinstrument. <200bp kan
              tyda på degraderade provmaterial (t.ex. FFPE), innan biblioteksberedning.<br />
              <ins>Fold 80 base penalty</ins
              >: Jämnhet av täckningsgraden över alla gener i analyspanlen. Ett värde mellan 1.0-1.8
              visar god jämnhet.<br />
              {% if "helgenomsekvensering" in case.data_analysis.type %}
              <ins>Läsningar med felaktiga par</ins
              >: Andelen (primära) läsningar som inte är korrekt parvis justerade.<br />
              {% else %}
              <ins>GC dropout</ins
              >: Ett mått på hur dåligt täckta områden, med >= 50% GC innehåll, är i jämförelse med
              medelvärdet. Om värdet är 5%, innebär det att 5% av alla läsningar som borde ha
              kartlagts till områden med GC<=50%, kartlades någon annanstans.<br />
              {% endif %}
              <br />
              Värdena presenterade för
              <ins>Täckningsgrad</ins>
              och
              <ins>Mediantäckning</ins>
              är efter borttagning av duplikata läsningar.
            </caption>
          </table>

          <div class="card-body">* Information given av kund</div>
        </div>

        {% if customer.scout_access and "scout" in case.data_analysis.data_delivery %}
        <div class="card-block">
          <h4 class="card-title">Scout</h4>
          <div class="card-text">
            <p>
              Varianter finns uppladdade i Scout:
              <a href="https://scout.scilifelab.se/{{ customer.id }}/{{ case.name }}"
                >scout.scilifelab.se/{{ customer.id }}/{{ case.name }}</a
              >
            </p>
            <ul>
              {% if case.data_analysis.scout_files.snv_vcf != 'N/A' %}
              <li>
                <strong>Kliniskt relevanta förvärvade SNVs och INDELs</strong>:
                <em>{{ case.data_analysis.scout_files.snv_vcf.replace(case.id, case.name) }}</em>
              </li>
              {% endif %} {% if case.data_analysis.scout_files.snv_research_vcf != 'N/A' %}
              <li>
                <strong>Förvärvade SNVs och INDELs för forskning</strong>:
                <em
                  >{{ case.data_analysis.scout_files.snv_research_vcf.replace(case.id, case.name)
                  }}</em
                >
              </li>
              {% endif %} {% if case.data_analysis.scout_files.sv_vcf != 'N/A' %}
              <li>
                <strong>Kliniskt relevanta förvärvade SVs</strong>:
                <em>{{ case.data_analysis.scout_files.sv_vcf.replace(case.id, case.name) }}</em>
              </li>
              {% endif %} {% if case.data_analysis.scout_files.sv_research_vcf != 'N/A' %}
              <li>
                <strong>Förvärvade SVs för forskning</strong>:
                <em
                  >{{ case.data_analysis.scout_files.sv_research_vcf.replace(case.id, case.name)
                  }}</em
                >
              </li>
              {% endif %}
            </ul>
          </div>
        </div>
        {% endif %} {% for application in case.applications %}
        <div class="card-block">
          <h4 class="card-title">Teknisk beskrivning av analysen: {{ application.tag }}</h4>
          <p class="card-text">{{ application.description }}</p>
          {% if application.details != 'N/A' %}
          <p class="card-text">{{ application.details }}</p>
          {% endif %} {% if application.limitations != 'N/A' %}
          <h4 class="card-title">Begränsningar av analysen: {{ application.tag }}</h4>
          <p class="card-text">{{ application.limitations }}</p>
          {% if application.workflow_limitations != 'N/A' %}
          <p class="card-text">{{ application.workflow_limitations }}</p>
          {% endif %} {% endif %}
        </div>
        {% endfor %}

        <div class="card-block">
          Laboratoriet har inte haft ansvar för provtagningsstadiet och extraktion, resultaten
          gäller för provet såsom det har mottagits.
        </div>

        <div class="card-block">
          <h4 class="card-title">Signatur för godkännande av rapport</h4>
          <p class="card-text">
            Valtteri Wirta<br />
            Director, Clinical Genomics
          </p>
        </div>

        <div class="card-block">
          All kommunikation gällande ordern såsom tillägg, avvikelser eller ev undantag i metoden
          från Clinical Genomics finns tillgängligt i SupportSystem för detta ticket id. En stängd
          ticket kan närsomhelst öppnas upp igen för frågor.
        </div>

        {% if "analysis" in case.data_analysis.data_delivery or "fastq" in
        case.data_analysis.data_delivery %}
        <div class="card-block">
          <h4 class="card-title">Bilaga</h4>
          <div class="card-text">
            <div class="card-block">
              <h5 class="card-title">Caesar</h5>
              <div class="card-text">
                <p>
                  Filer som ska laddas upp till din inkorg:
                  <i>/home/{{ customer.id }}/inbox/{{ case.samples[0].ticket }}</i>
                </p>
                <ul>
                  {% if "analysis" in case.data_analysis.data_delivery %}
                  <li><b>Analysfiler</b>:</li>
                  <ul>
                    {% if case.data_analysis.delivered_files != 'N/A' %}
                    <li><b>Fall</b>: {{ case.name }}</li>
                    <ul>
                      {% for file in case.data_analysis.delivered_files %}
                      <li>{{ file }}</li>
                      {% endfor %}
                    </ul>
                    {% endif %} {% for sample in case.samples %} {% if sample.delivered_files !=
                    'N/A' %}
                    <li><b>Prov</b>: {{ sample.name }}</li>
                    <ul>
                      {% for file in sample.delivered_files %}
                      <li>{{ file }}</li>
                      {% endfor %}
                    </ul>
                    {% endif %} {% endfor %}
                  </ul>
                  {% endif %} {% if "fastq" in case.data_analysis.data_delivery %}
                  <li><b>Fastq-filer</b>:</li>
                  <ul>
                    {% for sample in case.samples %} {% if sample.delivered_fastq_files != 'N/A' %}
                    <li><b>Prov</b>: {{ sample.name }}</li>
                    <ul>
                      {% for file in sample.delivered_fastq_files %}
                      <li>{{ file }}</li>
                      {% endfor %}
                    </ul>
                    {% endif %} {% endfor %}
                  </ul>
                  {% endif %}
                </ul>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="card-footer">
          <div class="text-muted text-center">Slut på rapport</div>
        </div>
      </div>
    </div>
  </body>
</html>
