{% from "/macros/data_analysis/qc_metrics/balsamic_qc_metrics.html" import balsamic_qc_metrics %}
{% from "/macros/data_analysis/qc_metrics/mip_dna_qc_metrics.html" import mip_dna_qc_metrics %}
{% from "/macros/data_analysis/qc_metrics/rnafusion_qc_metrics.html" import rnafusion_qc_metrics %}
{% from "/macros/data_analysis/limitations.html" import apptag_limitations %}

<!-- Data analysis results -->
{% macro data_analysis(case) %}
  <div class="container mb-5">
  <h3 class="mb-4">Analys</h3>
    {{ workflow_analysis(case=case) }}
    <h4 class="mt-4 mb-3">Kvalitetskontrollsmetrik</h4>
    {% if "balsamic" in case.data_analysis.workflow %}
      {{ balsamic_qc_metrics(samples=case.samples, analysis_type=case.data_analysis.type) }}
    {% elif "mip-dna" == case.data_analysis.workflow %}
      {{ mip_dna_qc_metrics(samples=case.samples) }}
    {% elif "rnafusion" == case.data_analysis.workflow %}
      {{ rnafusion_qc_metrics(samples=case.samples) }}
    {% endif %}
    {{ apptag_limitations(applications=case.applications) }}
  </div>
{% endmacro %}

<!-- Workflow analysis -->
{% macro workflow_analysis(case) %}
  <h4 class="mt-4 mb-3">Dataanalys</h4>
  <table class="table w-auto text-center align-middle" aria-describedby="data-analysis-table">
    <thead class="table-secondary">
      <tr>
        <th scope="col">Fall</th>
        <th scope="col">Bioinformatisk analys</th>
        <th scope="col">Genomversion</th>
        <th scope="col">{% if "balsamic" in case.data_analysis.workflow %} Analystyp {% endif %}</th>
        <th scope="col">
          {% if case.data_analysis.workflow in ("balsamic", "balsamic-umi") %} Variantanropare {% endif %}
        </th>
        <th scope="col">{% if case.data_analysis.workflow in ("mip-dna", "rnafusion") %} Genpaneler {% endif %}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th scope="row">{{ case.name }}</th>
        <td>{{ case.data_analysis.workflow }} (v{{ case.data_analysis.workflow_version }})</td>
        <td>{{ case.data_analysis.genome_build }}</td>
        <td>{% if "balsamic" in case.data_analysis.workflow %} {{ case.data_analysis.type }} {% endif %}</td>
        <td>{{ analysis_type_value(workflow=case.data_analysis.workflow, analysis_type=case.data_analysis.type) }}</td>
        <td class="text-start">
          {% if case.data_analysis.workflow in ("balsamic", "balsamic-umi") %} {{ case.data_analysis.variant_callers }} {% endif %}
        </td>
        <td>{% if case.data_analysis.workflow in ("mip-dna", "rnafusion") %} {{ case.data_analysis.panels }} {% endif %}</td>
      </tr>
    </tbody>
  </table>
  {{ data_analysis_alert(case=case) }}
{% endmacro %}

<!-- Data analysis alert component -->
{% macro data_analysis_alert(case) %}
  {% if "balsamic" in case.data_analysis.workflow and case.data_analysis.workflow != "balsamic-qc" %}
    <div class="alert alert-info" role="alert">
      Den tillämpade variantanropningsfiltrerna finns på:
      <a href="https://balsamic.readthedocs.io/en/latest/balsamic_filters.html" class="alert-link">
        https://balsamic.readthedocs.io/en/latest/balsamic_filters.html</a>.
    </div>
  {% elif "rnafusion" == case.data_analysis.workflow %}
    {% if case.data_analysis.scout_files.vcf_fusion != "N/A" %}
      <div class="alert alert-primary" role="alert">
        Ingen filtrering har utförts. Alla upptäckta varianter rapporteras.
      </div>
    {% else %}
      <div class="alert alert-warning" role="alert">
        Inga fusionsvarianter upptäcktes.
      </div>
    {% endif %}
    <div class="alert alert-info" role="alert">
      Workflowinformation och bioinformatiska verktygsversioner:
      <a href="https://nf-co.re/rnafusion" class="alert-link">https://nf-co.re/rnafusion</a>.
    </div>
  {% endif %}
{% endmacro %}
