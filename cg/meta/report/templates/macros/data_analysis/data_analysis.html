{% from "/macros/data_analysis/limitations.html" import apptag_limitations %}
{% from "/macros/data_analysis/metrics/balsamic_metrics.html" import balsamic_metrics %}
{% from "/macros/data_analysis/metrics/mip_dna_metrics.html" import mip_dna_metrics %}
{% from "/macros/data_analysis/metrics/rnafusion_metrics.html" import rnafusion_metrics %}

<!-- Data analysis results -->
{% macro data_analysis(case) %}
  <div class="container mb-5">
  <h4 class="mb-4">Analys</h4>
    {{ workflow_analysis(case=case) }}
    {{ apptag_limitations(applications=case.applications) }}
    <h5 class="mt-4 mb-3">Kvalitetskontrollsmetrik</h5>
    {% if "balsamic" in case.data_analysis.workflow %}
      {{ balsamic_metrics() }}
    {% elif "mip-dna" == case.data_analysis.workflow %}
      {{ mip_dna_metrics() }}
    {% elif "rnafusion" == case.data_analysis.workflow %}
      {{ rnafusion_metrics() }}
    {% endif %}
  </div>
{% endmacro %}

<!-- Workflow analysis -->
{% macro workflow_analysis(case) %}
  <h5 class="mt-4 mb-3">Dataanalys</h5>
  <table class="table w-auto text-center align-middle">
    <thead class="table-secondary">
      <tr>
        <th scope="col">Fall</th>
        <th scope="col">Bioinformatisk analys</th>
        <th scope="col">Genomversion</th>
        <th scope="col">{{ analysis_type(workflow=case.data_analysis.workflow) }}</th>
        <th scope="col">{{ variant_callers(workflow=case.data_analysis.workflow) }}</th>
        <th scope="col">{{ gene_panels(workflow=case.data_analysis.workflow) }}</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <th>{{ case.name }}</th>
        <td>{{ case.data_analysis.workflow }} (v{{ case.data_analysis.workflow_version }})</td>
        <td>{{ case.data_analysis.genome_build }}</td>
        <td>{{ analysis_type_value(workflow=case.data_analysis.workflow, analysis_type=case.data_analysis.type) }}</td>
        <td>{{ variant_callers_value(case=case) }}</td>
        <td>{{ gene_panels_value(case=case) }}</td>
      </tr>
    </tbody>
  </table>
  {{ data_analysis_alert(case=case) }}
{% endmacro %}

<!-- Analysis type column -->
{% macro analysis_type(workflow) %}
  {% if "balsamic" in workflow %}
    Analystyp
  {% endif %}
{% endmacro %}

<!-- Analysis type value -->
{% macro analysis_type_value(workflow, analysis_type) %}
  {% if "balsamic" in workflow %}
    {{ analysis_type }}
  {% endif %}
{% endmacro %}

<!-- Gene panels column -->
{% macro gene_panels(workflow) %}
  {% if "mip-dna" == workflow or "rnafusion" == workflow %}
    Genpaneler
  {% endif %}
{% endmacro %}

<!-- Gene panels value -->
{% macro gene_panels_value(case) %}
  {% if "mip-dna" == case.data_analysis.workflow or "rnafusion" == case.data_analysis.workflow %}
    {{ case.data_analysis.panels }}
  {% endif %}
{% endmacro %}

<!-- Variant callers column -->
{% macro variant_callers(workflow) %}
  {% if "balsamic" in workflow and workflow != "balsamic-qc" %}
    Variantanropare
  {% endif %}
{% endmacro %}

<!-- Variant callers value -->
{% macro variant_callers_value(case) %}
  {% if "balsamic" in case.data_analysis.workflow and case.data_analysis.workflow != "balsamic-qc" %}
    {{ case.data_analysis.variant_callers }}
  {% endif %}
{% endmacro %}

<!-- Data analysis alert component -->
{% macro data_analysis_alert(case) %}
  {% if "balsamic" in case.data_analysis.workflow and case.data_analysis.workflow != "balsamic-qc" %}
    <div class="alert alert-info" role="alert">
      Den tillämpade variantanropningsfiltrerna finns på:
      <a href="https://balsamic.readthedocs.io/en/latest/balsamic_filters.html" class="alert-link">
        https://balsamic.readthedocs.io/en/latest/balsamic_filters.html</a>.
    </div>
  {% elif "rnafusion" == case.data_analysis.workflow %}
    {% if case.data_analysis.scout_files.vcf_fusion != "N/A" %}
      <div class="alert alert-primary" role="alert">
        Ingen filtrering har utförts. Alla upptäckta varianter rapporteras.
      </div>
    {% else %}
      <div class="alert alert-warning" role="alert">
        Inga fusionsvarianter upptäcktes.
      </div>
    {% endif %}
    <div class="alert alert-info" role="alert">
      Workflowinformation och bioinformatiska verktygsversioner:
      <a href="https://nf-co.re/rnafusion" class="alert-link">https://nf-co.re/rnafusion</a>.
    </div>
  {% endif %}
{% endmacro %}
