{% from "/macros/balsamic/uploaded_files.html" import balsamic_scout_files %}
{% from "/macros/mip_dna/uploaded_files.html" import mip_dna_scout_files %}
{% from "/macros/rnafusion/uploaded_files.html" import rnafusion_scout_files %}

<!-- Uploaded files -->
{% macro uploaded_files(case, customer) %}
  {% 
    if "fastq" in case.data_analysis.data_delivery or
    "analysis" in case.data_analysis.data_delivery or
    "fastq" in case.data_analysis.data_delivery
  %}
    <div class="container mb-5">
      <h4 class="mb-4">Uppladdade filer</h4>
      <div class="alert alert-light" role="alert">
        Ytterligare information om de specifika levererade filerna finns p√•:
        <a href="https://clinical.scilifelab.se/data-delivery" class="alert-link">
          https://clinical.scilifelab.se/data-delivery
        </a>
      </div>
      {{ scout_files(case=case, customer_id=customer.id, scout_access=customer.scout_access) }}
      {{ caesar_files(case=case, customer_id=customer.id) }}
    </div>
  {% endif %}  
{% endmacro %}

<!-- Scout files -->
{% macro scout_files(case, customer_id, scout_access) %}
  {% if scout_access and "scout" in case.data_analysis.data_delivery %}
    <h5 class="mt-4 mb-3">Scout</h5>
    <div class="alert alert-light" role="alert">
      Varianter finns uppladdade i Scout:
      <a href="https://scout.scilifelab.se/{{ customer_id }}/{{ case.name }}" class="alert-link">
        https://scout.scilifelab.se/{{ customer_id }}/{{ case.name }}
      </a>
    </div>
    {% if "balsamic" in case.data_analysis.workflow %}
      {{ balsamic_scout_files(scout_files=case.data_analysis.scout_files, case_id=case.id, case_name=case.name) }}
    {% elif "mip-dna" == case.data_analysis.workflow %}
      {{ mip_dna_scout_files(scout_files=case.data_analysis.scout_files, case_id=case.id, case_name=case.name) }}
    {% elif "rnafusion" == case.data_analysis.workflow %}
      {{ rnafusion_scout_files(scout_files=case.data_analysis.scout_files, case_id=case.id, case_name=case.name) }}
    {% endif %}
  {% endif %}
{% endmacro %}

<!-- Caesar files -->
{% macro caesar_files(case, customer_id) %}
  {% if "analysis" in case.data_analysis.data_delivery or "fastq" in case.data_analysis.data_delivery %}
    <h5 class="mt-4 mb-3">Leveransinkorg (Caesar)</h5>
    <div class="alert alert-light" role="alert">
      Filer som ska laddas upp till din inkorg:
      <a class="alert-link">/home/{{ customer_id }}/inbox/{{ case.samples[0].ticket }}</a>
    </div>
    {{ analysis_files(case=case) }}
    {{ fastq_files(case=case) }}
  {% endif %}
{% endmacro %}

<!-- Analysis files -->
{% macro analysis_files(case) %}
  {% if "analysis" in case.data_analysis.data_delivery %}
    <table class="table w-auto align-middle">
      <thead class="table-secondary">
        <tr>
          <th scope="col" colspan="2">Analysfiler</th>
        </tr>
      </thead>
      <tbody>
        {{ delivered_files(row_title=case.name, files=case.data_analysis.delivered_files) }}
        {% for sample in case.samples %}
          {{ delivered_files(row_title=sample.name, files=sample.delivered_files) }}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endmacro %}

<!-- Fastq files -->
{% macro fastq_files(case) %}
  {% if "fastq" in case.data_analysis.data_delivery %}
    <table class="table w-auto align-middle">
      <thead class="table-secondary">
        <tr>
          <th scope="col" colspan="2">Fastq-filer</th>
        </tr>
      </thead>
      <tbody>
        {% for sample in case.samples %}
          {{ delivered_files(row_title=sample.name, files=sample.delivered_fastq_files) }}
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endmacro %}

<!-- Delivered files -->
{% macro delivered_files(row_title, files) %}
  {% if files != "N/A" %}
    <tr>
      <th scope="row" rowspan="{{ files | length + 1}}">{{ row_title }}</th>
    </tr>
    {% for file in files %}
      <tr>
        <td>{{ file }}</td>
      </tr>
    {% endfor %}
  {% endif %}
{% endmacro %}
